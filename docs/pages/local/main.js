import{resize_square,stroke_circle,stroke_circle_2,fill_circle_2,clear,line,fill_text}from"./canvas";import{collision_response,distance_sqrd,wrap_around,normalize,delta,rotate,add,del,mul,mod}from"./math";const style=()=>"\n    #content {\n      display: flex;\n      width: 100%;\n      height: 100%;\n      align-content: center;\n      align-items: center;\n      flex-direction: row;\n    }\n    #content > div {\n      width: 0;\n      flex-grow: 1;\n    }\n    p {\n      text-align: center;\n      color: #ffa;\n      font-family: monospace;\n    }\n    #canvas {\n        background: #113;\n        display:flex;\n        position: unset;\n    }\n    body {\n      background: #113;\n    }\n  ",DIAM=.0125,parts=[],links=[],links_set=new Set,add_part=(n,e,o,r,s)=>{const i=parts.length;return parts.push({idx:i,kind:s,d:DIAM,dp:{x:o,y:r},pp:{x:n-o,y:e-r},p:{x:n,y:e},np:{x:n,y:e},collision_response:{x:0,y:0,count:0},link_response:{x:0,y:0},links:new Set,direction:{x:0,y:0}}),i},add_link=(n,e)=>{const o=n<e?`${n}|${e}`:`${e}|${n}`;links_set.has(o)||(links.push({a:n,b:e}),links_set.add(o),parts[n].links.add(e),parts[e].links.add(n))},local_main=()=>{document.querySelector("#content").innerHTML='\n    <div>\n      <p>Move with F, J</p>\n    </div>\n    <canvas id="canvas"></canvas>\n    <div>\n    </div>\n  ';const n=document.createElement("style");document.head.appendChild(n);for(let e of"\n    #content {\n      display: flex;\n      width: 100%;\n      height: 100%;\n      align-content: center;\n      align-items: center;\n      flex-direction: row;\n    }\n    #content > div {\n      width: 0;\n      flex-grow: 1;\n    }\n    p {\n      text-align: center;\n      color: #ffa;\n      font-family: monospace;\n    }\n    #canvas {\n        background: #113;\n        display:flex;\n        position: unset;\n    }\n    body {\n      background: #113;\n    }\n  ".split("}"))try{n.sheet.insertRule(e+"}")}catch(n){}const e=document.querySelector("#canvas");resize_square(e);const o=e.getContext("2d"),r={p1:"core",p2:"armor",parts:[[0,1,"armor"],[0,2,"armor"],[0,3,"armor"],[0,4,"armor"],[0,5,"armor"]],links:[[1,6]],key_bindings:{}};add_ship({p1:"core",p2:"core",parts:[[0,1,"armor"],[0,2,"gun"],[0,3,"armor"],[0,4,"armor"],[0,5,"armor"],[2,1,"gun"],[7,1,"armor"],[8,1,"armor"],[6,5,"armor"],[9,6,"armor"],[8,9,"armor"],[5,4,"armor"],[5,13,"booster"],[12,9,"booster"],[4,3,"armor"],[7,8,"armor"]],links:[[1,6],[6,9],[10,11]],key_bindings:{f:[14],j:[15]}},.5,.5),add_ship(r,.25,.5),add_ship(r,.5,.25),add_ship(r,.75,.5),add_ship(r,.5,.75);for(var s=0;s<100;s++);render(o),compute(),document.addEventListener("keydown",(n=>{if(key_bindings.get(n.key))for(let e of key_bindings.get(n.key))parts[e].activated=!0})),document.addEventListener("keyup",(n=>{if(key_bindings.get(n.key))for(let e of key_bindings.get(n.key))parts[e].activated=!1}))},key_bindings=new Map,add_ship=(n,e,o)=>{const r=parts.length,s=parts.length+1;add_part(e-.00625,o,0,0,n.p1),add_part(e+.00625,o,0,0,n.p2);for(let e of n.parts){const n=parts[r+e[0]],o=parts[r+e[1]],s=rotate(n.p,o.p,1/6),i=add_part(s.x,s.y,0,0,e[2]);add_link(i,n.idx),add_link(i,o.idx)}add_link(r,s);for(let e of n.links)add_link(e[0]+r,e[1]+r);for(let e of Object.keys(n.key_bindings)){key_bindings.has(e)||key_bindings.set(e,new Set);for(let o of n.key_bindings[e])key_bindings.get(e).add(o+r)}},average_color=(n,e)=>(n={r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)},e={r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)},`rgb(${.5*(n.r+e.r)*17},${.5*(n.g+e.g)*17},${.5*(n.b+e.b)*17})`),render=n=>{clear(n);const e={glass:{value:"#aaf3",score:3},booster:{value:"#fb0",value_1:"#fa0",value_2:"#f80",value_3:"#f00",score:2},core:{value:"#ffa",score:4},armor:{value:"#aaf",score:3},gun:{value:"#f88",score:1}};for(let o of parts)o.activated&&"booster"==o.kind?(fill_circle_2(n,add(o.p,mul(o.direction,.007+.003*Math.random())),.7*o.d,e[o.kind].value_3),fill_circle_2(n,add(o.p,mul(o.direction,.005+.001*Math.random())),.9*o.d,e[o.kind].value_2),fill_circle_2(n,o.p,o.d,e[o.kind].value_1)):fill_circle_2(n,o.p,o.d,e[o.kind].value);for(let o of Object.keys(e))for(let r of links){const s=parts[r.a],i=parts[r.b],t=wrap_around(s.np,i.np),a=mul(delta(t.a,t.b),.5),l=e[s.kind].score>e[i.kind].score?s.kind:i.kind;if(o==l){const o=e[l].value,r=.75;fill_circle_2(n,add(s.p,a),s.d*r,o),fill_circle_2(n,del(i.p,a),i.d*r,o)}}for(let n of links){const e=parts[n.a],o=parts[n.b],r=wrap_around(e.np,o.np);delta(r.a,r.b)}for(let n of parts);window.requestAnimationFrame((()=>{render(n)}))},compute=()=>{let n=0;for(let e of parts){e.direction={x:0,y:0};for(let n of e.links){const o=parts[n],r=wrap_around(e.p,o.p);e.direction=add(e.direction,delta(r.b,r.a))}e.direction=normalize(e.direction),e.dp.x=e.p.x-e.pp.x,e.dp.y=e.p.y-e.pp.y,"booster"==e.kind&&e.activated&&(e.dp.x-=1e-4*e.direction.x,e.dp.y-=1e-4*e.direction.y),e.np.x=e.p.x+e.dp.x,e.np.y=e.p.y+e.dp.y,e.link_response.x=0,e.link_response.y=0,e.collision_response.x=0,e.collision_response.y=0,e.collision_response.count=0,n+=distance_sqrd(e.dp)}for(let n of parts)for(let e of parts)if(n.idx<e.idx){const o=wrap_around(n.np,e.np);o.a.np={x:o.a.x,y:o.a.y},o.b.np={x:o.b.x,y:o.b.y},o.a.dp=n.dp,o.b.dp=e.dp;const r=o.d_sqrd,s=.5*(n.d+e.d);if(r<s*s){let r=collision_response(o.a,o.b);links_set.has(`${n.idx}|${e.idx}`)&&(r.x*=.5,r.y*=.5),n.collision_response.x-=r.x,n.collision_response.y-=r.y,n.collision_response.count+=1,e.collision_response.x+=r.x,e.collision_response.y+=r.y,e.collision_response.count+=1}}for(let n of links){const e=parts[n.a],o=parts[n.b],r=wrap_around(e.np,o.np),s=.1,i=Math.sqrt(r.d_sqrd),t=normalize(delta(r.a,r.b),i),a=(.5*(e.d+o.d)-i)*s;e.link_response.x-=t.x*a*.5,e.link_response.y-=t.y*a*.5,o.link_response.x+=t.x*a*.5,o.link_response.y+=t.y*a*.5}for(let n of parts)n.collision_response.count&&(n.collision_response.x/=n.collision_response.count,n.collision_response.y/=n.collision_response.count,n.np.x+=n.collision_response.x,n.np.y+=n.collision_response.y,n.np.x+=n.link_response.x,n.np.y+=n.link_response.y),n.p.x=(n.np.x+1)%1,n.p.y=(n.np.y+1)%1,n.pp.x=n.p.x-n.dp.x-n.collision_response.x-n.link_response.x,n.pp.y=n.p.y-n.dp.y-n.collision_response.y-n.link_response.y;window.setTimeout((()=>{compute()}),10)};export{local_main};