import{resize_square,stroke_circle,stroke_circle_2,fill_circle_2,fill_circle,clear,line,fill_text}from"../canvas";import{colors}from"../colors";import{collision_response,distance_sqrd,wrap_around,normalize,delta,rotate,add,del,mul,mod}from"../math";import{get_fps,update_fps,get_ups,update_ups,get_ups_avg_delta}from"../perf";import{ship_0,ship_2,ship_1,emerald}from"../ship";const LINK_STRENGH=.2,GRID_SIDE=20,CELL_COUNT=400,DIAM=.0125,LOADING_AWAIT=1;let scores=[0,0],CONTINUE_RENDER=!0;const html=()=>`\n    <div id="winner" class="hide">\n      <p><span id="winner_name">..</span> Wins!</p>\n      <button onclick="again()">Play Again<br>[space]</button>\n    </div>\n    <div class="bob">\n      <input class="player_name"  id="player_1_name"\n        value="${localStorage.getItem("player_1_name")?localStorage.getItem("player_1_name"):"Blue"}"\n        oninput="localStorage.setItem('player_1_name', document.querySelector('#player_1_name').value)"></input>\n      <p><span id="score_player_1"></span></p>\n      <p id="move_with_instructions" class="disappearable disappear">Loading...</p>\n      <p class="disappearable disappear"> <a href="garage">Go to Garage</a> </p>\n      <p class="disappearable disappear"> <a href="journey">Journey</a> </p>\n      <p class="disappearable disappear"> <a href="https://github.com/loicbourgois/gravitle">Github</a> </p>\n    </div>\n    <canvas id="canvas"></canvas>\n    <div class="bob">\n      <input class="player_name"  id="player_2_name"\n        value="${localStorage.getItem("player_2_name")?localStorage.getItem("player_2_name"):"Green"}"\n        oninput="localStorage.setItem('player_2_name', document.querySelector('#player_2_name').value)"></input>\n      <p><span id="score_player_2"></span></p>\n      <p class="disappearable disappear">${select_mode()}</p>\n      <p class="disappearable disappear">${select_arena()}</p>\n      <p class="disappearable disappear">FPS: <span id="fps">...</span></p>\n      <p class="disappearable disappear">UPS: <span id="ups">...</span></p>\n    </div>\n  `,update_select_mode_option=()=>{const e=document.querySelector("#select_mode").value;localStorage.setItem("select_mode_option",e),again()},select_mode=()=>{const e=localStorage.getItem("select_mode_option"),n=[{value:"first_16",text:"First to 16"},{value:"first_32",text:"First to 32"}].map((n=>`<option value=${n.value} ${n.value==e?"selected":""}>${n.text}</option>`));return`<select id="select_mode" onchange="update_select_mode_option()">\n    ${n}\n  </select>`},update_select_arena_option=()=>{const e=document.querySelector("#select_arena").value;localStorage.setItem("select_arena_option",e),again()},select_arena=()=>{const e=localStorage.getItem("select_arena_option"),n=[{value:"octo",text:"Octo"},{value:"empty",text:"Empty"}].map((n=>`<option value=${n.value} ${n.value==e?"selected":""}>${n.text}</option>`));return`<select id="select_arena" onchange="update_select_arena_option()">\n    ${n}\n  </select>`},style=()=>"\n    * {\n      color: #ffa;\n      background: #113;\n      font-size: 1.05rem;\n    }\n    select {\n      border: none;\n    }\n    option {\n    }\n    #content {\n      display: flex;\n      width: 100%;\n      height: 100%;\n      align-content: center;\n      align-items: center;\n      flex-direction: row;\n    }\n    a {\n      color: #ffa;\n      text-decoration: none;\n      background-color: #fff0;\n      padding: 0.8rem;\n    }\n    .disappear, .disappear * {\n      color: #0000;\n      transition: color 0.2s;\n    }\n    a:hover {\n      background-color: #fff2;\n    }\n    #score_player_1, #score_player_2 {\n      font-size: 2rem;\n    }\n    #content > div.bob {\n      width: 0;\n      flex-grow: 1;\n      display: flex;\n      justify-content: space-around;\n      flex-direction: column;\n      height: 100%;\n    }\n    p {\n      text-align: center;\n      color: #ffa;\n      font-family: monospace;\n    }\n    p span {\n      color: #ffa;\n    }\n    #canvas {\n        background: #113;\n        display:flex;\n        position: unset;\n    }\n    body {\n      background: #113;\n    }\n    #winner {\n      position: absolute;\n      height: 100vh;\n      width: 100vw;\n      background: #0000;\n      display: flex;\n      flex-direction: column;\n      align-content: center;\n      align-items: center;\n      justify-content: center;\n      pointer-events: none;\n    }\n    #winner > p {\n      background: #ffaa;\n      padding: 5rem;\n      border-radius: 10rem;\n      border: solid 5px #ffa;\n    }\n    #winner > p > span, #winner > p  {\n      color: #ffa;\n      font-size: 3rem;\n    }\n    #winner > p > span {\n      background: transparent;\n    }\n    #winner > button {\n      border: none;\n      margin: 2rem;\n      cursor: pointer;\n      pointer-events: all;\n      padding: 1rem;\n      border-radius: 10rem;\n      background: #fff0;\n      line-height: 1.5rem;\n    }\n    #winner > button:hover {\n      background: #fff2;\n    }\n    .hide {\n      display: none !important;\n    }\n    a {\n      border-radius: 10rem;\n    }\n    .player_name {\n      text-align: center;\n      background: none;\n      border: solid 2px transparent;\n      margin-left: 1rem;\n      margin-right: 1rem;\n      padding: 0.5rem;\n      font-size: 1.5rem;\n    }\n    .player_name:hover {\n      border: solid 2px #ffdd;\n    }\n  ",grid_id=e=>parseInt(20*e.y)%20*20+parseInt(20*e.x)%20,grid_id_3=(e,n)=>n%20*20+e%20,grid_ids=[],grid=[];for(var x=0;x<20;x++)for(var y=0;y<20;y++){const e=[(x-1+20)%20,(x+20)%20,(x+1+20)%20],n=[(y-1+20)%20,(y+20)%20,(y+1+20)%20],a=grid_id_3(x,y);grid_ids.push([]),grid_ids[a]=[grid_id_3(e[0],n[0]),grid_id_3(e[0],n[1]),grid_id_3(e[0],n[2]),grid_id_3(e[1],n[0]),grid_id_3(e[1],n[1]),grid_id_3(e[1],n[2]),grid_id_3(e[2],n[0]),grid_id_3(e[2],n[1]),grid_id_3(e[2],n[2])],grid.push(new Set)}let winner,parts=[],parts_deleted=new Set,links=[],links_set=new Set,key_bindings=new Map,emeralds=[],key_allowed=!1;const sleep=e=>new Promise(e?n=>setTimeout(n,e):e=>e()),add_part=(e,n,a,r,i)=>{const t=parts.length;return parts.push({idx:t,kind:i,d:DIAM,dp:{x:a,y:r},pp:{x:e-a,y:n-r},p:{x:e,y:n},np:{x:e,y:n},collision_response:{x:0,y:0,count:0},link_response:{x:0,y:0},links:new Set,direction:{x:0,y:0}}),t},add_link=(e,n,a)=>{const r=e<n?`${e}|${n}`:`${n}|${e}`;links_set.has(r)&&!a||(links.push({a:e,b:n}),links_set.add(r),parts[e].links.add(n),parts[n].links.add(e))},add_player_ship=async(e,n,a)=>{const r=parts.length;for(let r of e.parts){const i=add_part((r.p.x-e.center.x)/e.DIAM*DIAM+n,(r.p.y-e.center.y)/e.DIAM*DIAM+a,0,0,r.kind);parts[i].player_id=r.player_id,r.binding&&(key_bindings.has(r.binding)||key_bindings.set(r.binding,new Set),key_bindings.get(r.binding).add(i)),await sleep(1)}for(let n of e.links)add_link(n.a+r,n.b+r),await sleep(1)},add_ship=async(e,n,a)=>{const r=parts.length,i=parts.length+1;add_part(n-.00625,a,0,0,e.p1),await sleep(1),add_part(n+.00625,a,0,0,e.p2),await sleep(1);for(let n of e.parts){const e=parts[r+n[0]],a=parts[r+n[1]],i=rotate(e.p,a.p,1/6),t=add_part(i.x,i.y,0,0,n[2]);add_link(t,e.idx),await sleep(1),add_link(t,a.idx),await sleep(1)}add_link(r,i),await sleep(1);for(let n of e.links)add_link(n[0]+r,n[1]+r),await sleep(1);for(let n of Object.keys(e.key_bindings)){key_bindings.has(n)||key_bindings.set(n,new Set);for(let a of e.key_bindings[n])key_bindings.get(n).add(a+r)}},average_color=(e,n)=>(e={r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)},n={r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)},`rgb(${.5*(e.r+n.r)*17},${.5*(e.g+n.g)*17},${.5*(e.b+n.b)*17})`),render=e=>{update_fps(),clear(e);for(let n of parts)n.deleted||(n.activated&&"booster"==n.kind?(fill_circle_2(e,add(n.p,mul(n.direction,.007+.003*Math.random())),.7*n.d,colors[n.kind].value_3),fill_circle_2(e,add(n.p,mul(n.direction,.005+.001*Math.random())),.9*n.d,colors[n.kind].value_2),fill_circle_2(e,n.p,n.d,colors[n.kind].value_1)):"booster"==n.kind?fill_circle_2(e,n.p,n.d,colors[n.kind].value):fill_circle_2(e,n.p,n.d,colors[n.kind].value[n.player_id]));for(let n of Object.keys(colors))for(let a of links){const r=parts[a.a],i=parts[a.b];if(r.deleted||i.deleted||a.deleted)continue;const t=wrap_around(r.np,i.np),o=mul(delta(t.a,t.b),.5),s=colors[r.kind].score>colors[i.kind].score?r.kind:i.kind;if(n==s){const n=colors[s].value[r.player_id],a=.75;fill_circle_2(e,add(r.p,o),r.d*a,n),fill_circle_2(e,del(i.p,o),i.d*a,n)}}document.getElementById("fps").innerHTML=get_fps(),document.getElementById("ups").innerHTML=get_ups(),document.getElementById("score_player_1").innerHTML=scores[0],document.getElementById("score_player_2").innerHTML=scores[1],CONTINUE_RENDER?window.requestAnimationFrame((()=>{render(e)})):again_2()},update_grid=()=>{for(var e=0;e<400;e++)grid[e].clear();for(let e of parts){const n=grid_id(e.p);grid[n].add(e.idx),e.grid_id=n}},neighbours=e=>{const n=grid_id(e);return new Set([...grid[grid_ids[n][0]],...grid[grid_ids[n][1]],...grid[grid_ids[n][2]],...grid[grid_ids[n][3]],...grid[grid_ids[n][4]],...grid[grid_ids[n][5]],...grid[grid_ids[n][6]],...grid[grid_ids[n][7]],...grid[grid_ids[n][8]]])},compute=()=>{update_grid();let e=0;for(let n of parts)if(!n.deleted){n.direction={x:0,y:0};for(let e of n.links){const a=parts[e],r=wrap_around(n.p,a.p);n.direction=add(n.direction,delta(r.b,r.a))}n.direction=normalize(n.direction),n.dp.x=n.p.x-n.pp.x,n.dp.y=n.p.y-n.pp.y,"booster"==n.kind&&n.activated&&(n.dp.x-=1e-4*n.direction.x,n.dp.y-=1e-4*n.direction.y),n.np.x=n.p.x+n.dp.x,n.np.y=n.p.y+n.dp.y,n.link_response.x=0,n.link_response.y=0,n.collision_response.x=0,n.collision_response.y=0,n.collision_response.count=0,e+=distance_sqrd(n.dp)}for(let e of parts)if(!e.deleted)for(let n of neighbours(e.p)){const a=parts[n];if(!a.deleted&&e.idx<a.idx){const n=wrap_around(e.np,a.np);n.a.np={x:n.a.x,y:n.a.y},n.b.np={x:n.b.x,y:n.b.y},n.a.dp=e.dp,n.b.dp=a.dp;const r=n.d_sqrd,i=.5*(e.d+a.d);if(r<i*i){let r=null,i=null;void 0!==e.player_id&&"emerald"==a.kind?(r=a.idx,i=e.player_id):void 0!==a.player_id&&"emerald"==e.kind&&(r=e.idx,i=a.player_id),r&&(parts[r].deleted=!0,parts_deleted.add(r),scores[i]+=1);let t=collision_response(n.a,n.b);links_set.has(`${e.idx}|${a.idx}`)&&(t.x*=.5,t.y*=.5),e.collision_response.x-=t.x,e.collision_response.y-=t.y,e.collision_response.count+=1,a.collision_response.x+=t.x,a.collision_response.y+=t.y,a.collision_response.count+=1}}}for(let e of links){const n=parts[e.a],a=parts[e.b];if(n.deleted&&a.deleted&&(e.deleted=!0),n.deleted||a.deleted||e.deleted)continue;const r=wrap_around(n.np,a.np),i=Math.sqrt(r.d_sqrd),t=normalize(delta(r.a,r.b),i),o=.2*(.5*(n.d+a.d)-i);n.link_response.x-=t.x*o*.5,n.link_response.y-=t.y*o*.5,a.link_response.x+=t.x*o*.5,a.link_response.y+=t.y*o*.5}for(let e of parts)e.deleted||(e.collision_response.count&&(e.collision_response.x/=e.collision_response.count,e.collision_response.y/=e.collision_response.count,e.np.x+=e.collision_response.x,e.np.y+=e.collision_response.y,e.np.x+=e.link_response.x,e.np.y+=e.link_response.y),e.p.x=(e.np.x+1)%1,e.p.y=(e.np.y+1)%1,e.pp.x=e.p.x-e.dp.x-e.collision_response.x-e.link_response.x,e.pp.y=e.p.y-e.dp.y-e.collision_response.y-e.link_response.y);for(var n=0;n<emeralds.length;n++){const e=emeralds[n];let r=0;for(var a of e)parts[a].deleted&&(r+=1);4===r&&(emeralds[n]=new_emerald())}update_ups(),winning_condition(),window.setTimeout((()=>{compute()}),10-get_ups_avg_delta())},winning_condition=()=>{if(null!=winner)return;let e=1/0;"first_16"==document.querySelector("#select_mode").value?e=16:"first_32"==document.querySelector("#select_mode").value&&(e=32);for(var n=0;n<scores.length;n++)scores[n]>=e&&(winner=n);null!=winner&&(document.querySelector("#winner").classList.remove("hide"),document.querySelector("#winner_name").innerHTML={0:document.querySelector("#player_1_name").value,1:document.querySelector("#player_2_name").value}[winner])},is_in_emerald=e=>{for(var n of emeralds)for(var a of n)if(e==a)return!0},get_free_idx=()=>{if(parts_deleted.size){const e=parts_deleted.keys().next().value;if(!is_in_emerald(e))return parts_deleted.delete(e),e}const e=parts.length;return parts.push({}),e},new_emerald=(e,n)=>{for(var a of(e||(e=.8*Math.random()+.1),n||(n=.8*Math.random()+.1),parts))if(wrap_around(a.p,{x:e,y:n}).d_sqrd<DIAM*DIAM*4*4)return new_emerald();const r=new Set;for(var i=0;i<4;i++)r.add(get_free_idx());return add_ship_2(emerald,e,n,[...r]),r},add_ship_2=(e,n,a,r)=>{const i=r[0],t=r[1];set_part(n-.00625,a,0,0,e.p1,r[0]),set_part(n+.00625,a,0,0,e.p2,r[1]);for(var o=0;o<e.parts.length;o++){const n=e.parts[o],a=parts[r[n[0]]],i=parts[r[n[1]]],t=rotate(a.p,i.p,1/6),s=r[o+2];set_part(t.x,t.y,0,0,n[2],s),add_link(s,a.idx,!0),add_link(s,i.idx,!0)}add_link(i,t,!0);for(let n of e.links)add_link(r[n[0]],r[n[1]],!0);for(let n of Object.keys(e.key_bindings)){key_bindings.has(n)||key_bindings.set(n,new Set);for(let a of e.key_bindings[n])key_bindings.get(n).add(r[a])}},set_part=(e,n,a,r,i,t)=>(parts[t]={idx:t,kind:i,d:DIAM,dp:{x:a,y:r},pp:{x:e-a,y:n-r},p:{x:e,y:n},np:{x:e,y:n},collision_response:{x:0,y:0,count:0},link_response:{x:0,y:0},links:new Set,direction:{x:0,y:0}},t),again=()=>{CONTINUE_RENDER=!1},again_2=async()=>{CONTINUE_RENDER=!0,parts=[],parts_deleted=new Set,links=[],links_set=new Set,key_bindings=new Map,emeralds=[],key_allowed=!1,winner=void 0,scores=[0,0],document.querySelector("#content").innerHTML=`\n    <div id="winner" class="hide">\n      <p><span id="winner_name">..</span> Wins!</p>\n      <button onclick="again()">Play Again<br>[space]</button>\n    </div>\n    <div class="bob">\n      <input class="player_name"  id="player_1_name"\n        value="${localStorage.getItem("player_1_name")?localStorage.getItem("player_1_name"):"Blue"}"\n        oninput="localStorage.setItem('player_1_name', document.querySelector('#player_1_name').value)"></input>\n      <p><span id="score_player_1"></span></p>\n      <p id="move_with_instructions" class="disappearable disappear">Loading...</p>\n      <p class="disappearable disappear"> <a href="garage">Go to Garage</a> </p>\n      <p class="disappearable disappear"> <a href="journey">Journey</a> </p>\n      <p class="disappearable disappear"> <a href="https://github.com/loicbourgois/gravitle">Github</a> </p>\n    </div>\n    <canvas id="canvas"></canvas>\n    <div class="bob">\n      <input class="player_name"  id="player_2_name"\n        value="${localStorage.getItem("player_2_name")?localStorage.getItem("player_2_name"):"Green"}"\n        oninput="localStorage.setItem('player_2_name', document.querySelector('#player_2_name').value)"></input>\n      <p><span id="score_player_2"></span></p>\n      <p class="disappearable disappear">${select_mode()}</p>\n      <p class="disappearable disappear">${select_arena()}</p>\n      <p class="disappearable disappear">FPS: <span id="fps">...</span></p>\n      <p class="disappearable disappear">UPS: <span id="ups">...</span></p>\n    </div>\n  `;const e=document.createElement("style");document.head.appendChild(e);for(let n of"\n    * {\n      color: #ffa;\n      background: #113;\n      font-size: 1.05rem;\n    }\n    select {\n      border: none;\n    }\n    option {\n    }\n    #content {\n      display: flex;\n      width: 100%;\n      height: 100%;\n      align-content: center;\n      align-items: center;\n      flex-direction: row;\n    }\n    a {\n      color: #ffa;\n      text-decoration: none;\n      background-color: #fff0;\n      padding: 0.8rem;\n    }\n    .disappear, .disappear * {\n      color: #0000;\n      transition: color 0.2s;\n    }\n    a:hover {\n      background-color: #fff2;\n    }\n    #score_player_1, #score_player_2 {\n      font-size: 2rem;\n    }\n    #content > div.bob {\n      width: 0;\n      flex-grow: 1;\n      display: flex;\n      justify-content: space-around;\n      flex-direction: column;\n      height: 100%;\n    }\n    p {\n      text-align: center;\n      color: #ffa;\n      font-family: monospace;\n    }\n    p span {\n      color: #ffa;\n    }\n    #canvas {\n        background: #113;\n        display:flex;\n        position: unset;\n    }\n    body {\n      background: #113;\n    }\n    #winner {\n      position: absolute;\n      height: 100vh;\n      width: 100vw;\n      background: #0000;\n      display: flex;\n      flex-direction: column;\n      align-content: center;\n      align-items: center;\n      justify-content: center;\n      pointer-events: none;\n    }\n    #winner > p {\n      background: #ffaa;\n      padding: 5rem;\n      border-radius: 10rem;\n      border: solid 5px #ffa;\n    }\n    #winner > p > span, #winner > p  {\n      color: #ffa;\n      font-size: 3rem;\n    }\n    #winner > p > span {\n      background: transparent;\n    }\n    #winner > button {\n      border: none;\n      margin: 2rem;\n      cursor: pointer;\n      pointer-events: all;\n      padding: 1rem;\n      border-radius: 10rem;\n      background: #fff0;\n      line-height: 1.5rem;\n    }\n    #winner > button:hover {\n      background: #fff2;\n    }\n    .hide {\n      display: none !important;\n    }\n    a {\n      border-radius: 10rem;\n    }\n    .player_name {\n      text-align: center;\n      background: none;\n      border: solid 2px transparent;\n      margin-left: 1rem;\n      margin-right: 1rem;\n      padding: 0.5rem;\n      font-size: 1.5rem;\n    }\n    .player_name:hover {\n      border: solid 2px #ffdd;\n    }\n  ".split("}"))try{e.sheet.insertRule(n+"}")}catch(e){}const n=document.querySelector("#canvas");resize_square(n);const a=n.getContext("2d"),r="2022.08.09";localStorage.getItem("ship")&&localStorage.getItem("version")===r||(localStorage.setItem("ship",ship_1),localStorage.setItem("version",r)),render(a),key_allowed=!1,await add_player_ship(JSON.parse(localStorage.getItem("ship")),.5,.5);const i=new Set;for(let e of key_bindings){const n=e[0],a=e[1];for(let e of a)"booster"==parts[e].kind&&i.add(n)}"octo"==document.querySelector("#select_arena").value&&(await add_ship(ship_2,.27,.5),await add_ship(ship_2,.5,.27),await add_ship(ship_2,.73,.5),await add_ship(ship_2,.5,.73),await add_ship(ship_2,.8,.8),await add_ship(ship_2,.2,.8),await add_ship(ship_2,.8,.2),await add_ship(ship_2,.2,.2)),i.size&&(document.querySelector("#move_with_instructions").innerHTML=`Move with ${Array.from(i).map((e=>e.toUpperCase())).join(", ")}`),emeralds.push(new_emerald()),emeralds.push(new_emerald()),key_allowed=!0},local_main=async()=>{window.update_select_mode_option=update_select_mode_option,window.update_select_arena_option=update_select_arena_option,window.again=again,document.addEventListener("keydown",(e=>{if(key_bindings.get(e.key)){if(key_allowed){document.querySelectorAll(".disappearable").forEach(((e,n)=>{e.classList.add("disappear")}));for(let n of key_bindings.get(e.key))parts[n].activated=!0}}else" "!=e.key?document.querySelectorAll(".disappearable").forEach(((e,n)=>{e.classList.remove("disappear")})):null!=winner&&key_allowed&&again()})),document.addEventListener("keyup",(e=>{if(key_bindings.get(e.key))for(let n of key_bindings.get(e.key))parts[n].activated=!1})),document.addEventListener("mousemove",(e=>{document.querySelectorAll(".disappearable").forEach(((e,n)=>{e.classList.remove("disappear")}))})),again_2(),compute(),document.querySelectorAll(".disappearable").forEach(((e,n)=>{e.classList.remove("disappear")}))};export{local_main};